{% extends "base.html" %}

{% block content %}
<div class="ai-chat-container">
    <div class="ai-messages" id="ai-messages">
        {% for msg in messages %}
        <div class="ai-message {{ 'user-message' if msg.role == 'user' else 'ai-message' }} 
            {% if msg.is_image %}image-message{% endif %}">
            
            <div class="message-header">
                <span class="role">{{ '–í—ã' if msg.role == 'user' else '–ò–ò' }}</span>
                <span class="timestamp">{{ msg.timestamp }}</span>
                {% if msg.is_image_request %}
                <span class="message-tag">üñºÔ∏è –ó–∞–ø—Ä–æ—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                {% endif %}
                {% if msg.role == 'assistant' and not msg.is_image %}
                <button class="copy-button" onclick="copyToClipboard(this)" 
                        data-content="{{ msg.content|escape_quotes }}">
                    <i class="fas fa-copy"></i>
                </button>
                {% endif %}
                {% if msg.used_web_search %}
                <span class="web-search-badge">üåê –í–µ–±-–ø–æ–∏—Å–∫</span>
                {% endif %}
            </div>
            
            <div class="message-content">
                {% if msg.is_image %}
                <div class="generated-image-container">
                    <img src="{{ msg.image_url }}" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="generated-image">
                    <div class="image-actions">
                        <a href="{{ msg.image_url }}" target="_blank" class="view-original">
                            –û—Ç–∫—Ä—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
                        </a>
                    </div>
                </div>
                {% else %}
                    {{ msg.content|safe }}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="ai-chat-controls">
        <div class="action-buttons">
            <form method="POST" class="image-gen-form">
                <input type="text" name="image_prompt" 
                       placeholder="–û–ø–∏—à–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ..." 
                       class="image-prompt-input"
                       required>
                <button type="submit" name="generate_image" class="image-gen-button">
                    <i class="fas fa-image"></i> Create
                </button>
            </form>
            
            <div class="right-buttons">
                <form method="POST" class="web-search-form">
                    <button type="submit" name="toggle_web_search" class="web-search-button {% if web_search %}active{% endif %}">
                        <i class="fas fa-globe"></i> –í–µ–±-–ø–æ–∏—Å–∫
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('clear_ai_history') }}" class="clear-history-form">
                    <button type="submit" class="clear-history-button">
                        <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
        
        <form method="POST" class="ai-message-form">
            <input type="text" name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å..." required>
            <button type="submit" class="send-button">
                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>
    </div>
</div>

<script>
function copyToClipboard(button) {
    const content = button.getAttribute('data-content');
    const temp = document.createElement('textarea');
    temp.value = content.replace(/<[^>]*>?/gm, '');
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    
    const icon = button.querySelector('i');
    icon.classList.remove('fa-copy');
    icon.classList.add('fa-check');
    setTimeout(() => {
        icon.classList.remove('fa-check');
        icon.classList.add('fa-copy');
    }, 2000);
}

document.querySelector('.web-search-button').addEventListener('click', function() {
    const isActive = this.classList.contains('active');
    showModal(isActive ? '–í–µ–±-–ø–æ–∏—Å–∫ –æ—Ç–∫–ª—é—á–µ–Ω' : '–í–µ–±-–ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
});
</script>

<script>
    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function showModal(message) {
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('loadingModal').style.display = 'flex';
    }

    // –°–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    function hideModal() {
        document.getElementById('loadingModal').style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    document.querySelector('.ai-message-form').addEventListener('submit', function() {
        showModal('–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...');
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.querySelector('.image-gen-form').addEventListener('submit', function() {
        const prompt = document.querySelector('input[name="image_prompt"]').value;
        if (prompt.trim() !== '') {
            showModal('–ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...');
        }
    });
</script>
{% endblock %}